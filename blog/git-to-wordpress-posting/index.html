<!DOCTYPE html>
<html>
    <head>
        <title>Постинг в WordPress из Git - It&#039;s a maze ink</title>
        <meta charset="utf-8">

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

            <meta name="robots" content="index, follow">

        <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="//viktoras.de/feed/" />
        <link rel="alternate" type="application/atom+xml" href="//viktoras.de/atom.xml" title="It&#039;s a maze ink activity feed" />

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link href="//viktoras.de/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <link rel="stylesheet" href="//viktoras.de/js/highlightjs/styles/github.css" />

                    </head>
    <body class="container">

                <div id="header">
            <div id="invader-wrapper" class="center-block">
                <a href="//viktoras.de">
                    <img id="invader" src="//viktoras.de/img/invader.png" alt="Invader">
                </a>
            </div>
        </div>
        
        <div class="col-md-12">

                <div class="post">
        <div class="content">
            <div class="postdata">
                    <span class="title">
                        <a href="/blog/git-to-wordpress-posting" rel="bookmark">Постинг в WordPress из Git</a>
                    </span>
                    <span class="date">11.02.2013</span>
            </div>
            <div class="entry">
                <p><img src="//viktoras.de/img/git.png" class="oppic">Этот пост я пишу совсем не в маленьком окошке TinyMCE, а в удобном Sublime Text 2. Более того, чтобы запостить его в блог, мне даже не придется заходить в админку. Пост автоматически появится на странице, когда я сделаю push в git репозиторий. А если я захочу что-то исправить, то опять же, достаточно будет сделать push, и пост будет автоматически исправлен.</p>

<p>Идея, в общем, не нова, многие слышали про Octopress, или блог bobuk'а, которые тоже работают через git. Правда вот никакого похожего плагина для Wordpress я не нашел. Только на одном из сайтов, на вопрос "А можно ли постить в блог через git?" ответили "...this is a massive job for what seems like a very small payoff...". Ну что ж, никому не надо, а мне надо.<!--more--></p>

<p>Будущую систему я назвал blocto, от слов blog и octo (от Octopus, подразумевая Github, хотя он не используется). Сами посты я решил хранить в статических файлах. Изначально это должны быть Markdown файлы, но я отказался от этой идеи из-за сложности в синхронизации постов. Я использую следующий формат файла:</p>

<pre><code class="yaml">tags: теги, разделенные, запятыми
categories: категории, разделенные, запятыми
type: тип поста (пост или страница)
author: id автора
post_status: статус поста (черновик, опубликованный)
comment_status: статус комментариев (открыты или закрыты)
title: Заголовок поста


Содержимое идет после двух пропущенных строк.
</code></pre>

<p>Само имя файла является идентификатором, и одновременно URI поста. Эти файлы находятся в git репозитории, так что я получаю версионность, а так же своего рода бекап. Я всегда смогу еще раз импортировать все эти файлы в Вордпесс.</p>

<p>Итак, доставка файлов на сервер реализуется с помощью пуша. В git присутствует отличная фича, которая называется хуки (hooks). Можно написать скрипт, который будет выполняться перед коммитом, после коммита, в разные другие моменты, в том числе после пуша. Я создал файл .git/hooks/post-receive, который является шелл скриптом, выполняемым при получении данных. Соответственно все, что нам нужно в нем сделать, это обновить файлы и запустить импорт, поэтому скрипт выглядит так:</p>

<pre><code class="bash">#!/bin/sh
GIT_WORK_TREE=/home/viktoras/blocto git checkout -f
php /home/viktoras/blocto/sync.php
</code></pre>

<p>Оставалось написать сам скрипт для импорта. Проще всего использовать API самого Wordpress, подключив файл wp-load.php. Тогда не придется вручную подключаться к базе. Скрипт можно <a href="https://gist.github.com/charnad/4974262">посмотреть на Github</a>. Скрипт распространяется под MIT лицензией. Это еще сырая альфа версия, и можно его много чего улучшать и добавлять.</p>

<p>Теперь, написание нового поста выглядит так:</p>

<pre><code class="bash">touch posts/new-post.md
edit posts/new-post.md
git add -u
git commit -m "New post"
git push wordpress master
</code></pre>

<p>Пост, который вы только что прочитали, был сделан именно таким образом.</p>

            </div>
        </div>
    </div>

        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'viktoras'; // required: replace example with your forum shortname

                                
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
        Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered byDisqus.</a>
    </noscript>
    
            <footer class="footer text-center">
                <small>&copy; 2018 Viktoras Bezaras
                    <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en">CC-BY-SA<img src="//viktoras.de/img/cc-by-sa.png" alt="CC-BY-SA"></a>
                </small>
            </footer>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="//viktoras.de/js/jquery/jquery.min.js"><\/script>')</script>

        <!-- Page scripts -->
        
        <!-- Google Analytics -->
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-15013831-1', 'auto');
                ga('send', 'pageview');
            </script>
        
        <!-- Highlight -->
        <script src="//viktoras.de/js/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <!-- More page scripts -->
                    </body>
</html>
